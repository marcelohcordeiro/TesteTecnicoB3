<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\TesteTecnicoB3\B3.Tests\CalculoSimulacaoTituloTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using B3.Application.Services;
using B3.Domain.Models;
using B3.Infra.Data.Context;
using B3.Infra.Data.Repositories;
using Microsoft.EntityFrameworkCore;

namespace B3.Tests
{
    public class CalculoSimulacaoTituloTests
    {
        private static async Task&lt;AppDbContext&gt; getDatabaseDbContext()
        {
            var options = new DbContextOptionsBuilder&lt;AppDbContext&gt;()
            .UseInMemoryDatabase(databaseName: &quot;TestDb&quot;)
            .Options;

            var databaseContext = new AppDbContext(options);
            await databaseContext.Database.EnsureCreatedAsync();

           


            if (!await databaseContext.Indexadores!.AnyAsync())
            {
                databaseContext.Indexadores!.Add(new Indexador { IdIndexador = 1, Descricao = &quot;SELIC&quot;, TaxaAtual = (decimal)0.9, DataUltimaAtualizacao = DateTime.Now });
                databaseContext.Indexadores!.Add(new Indexador { IdIndexador = 2, Descricao = &quot;CDI&quot;, TaxaAtual = (decimal)0.9, DataUltimaAtualizacao = DateTime.Now });
                databaseContext.Indexadores!.Add(new Indexador { IdIndexador = 3, Descricao = &quot;IPCA&quot;, TaxaAtual = (decimal)0.9, DataUltimaAtualizacao = DateTime.Now });

                await databaseContext.SaveChangesAsync();
            }


            if (!await databaseContext.TipoTitulos!.AnyAsync())
            {
                databaseContext.TipoTitulos!.Add(new TipoTitulo { IdTipoTitulo = 1, Descricao = &quot;Tesouro Direto&quot;, RendaFixa = true });
                databaseContext.TipoTitulos!.Add(new TipoTitulo { IdTipoTitulo = 2, Descricao = &quot;Tesouro IPCA&quot;, RendaFixa = true });
                databaseContext.TipoTitulos!.Add(new TipoTitulo { IdTipoTitulo = 3, Descricao = &quot;CDB&quot;, RendaFixa = true });

                await databaseContext.SaveChangesAsync();
            }



            if (!await databaseContext.descontoImpostoRendas!.AnyAsync())
            {
                databaseContext.descontoImpostoRendas!.Add(new DescontoImpostoRenda { IdDescontoImpostoRenda = Guid.NewGuid(), Descricao = &quot;&#39;At� 06 meses&#39;&quot;, QtdeMesesInicio = 0, QtdeMesesFim = 6, PercentualDesconto = (decimal)22.5 });
                databaseContext.descontoImpostoRendas!.Add(new DescontoImpostoRenda { IdDescontoImpostoRenda = Guid.NewGuid(), Descricao = &quot;&#39;At� 12 meses&#39;&quot;, QtdeMesesInicio = 7, QtdeMesesFim = 12, PercentualDesconto = (decimal)20 });
                databaseContext.descontoImpostoRendas!.Add(new DescontoImpostoRenda { IdDescontoImpostoRenda = Guid.NewGuid(), Descricao = &quot;&#39;At� 24 meses&#39;&quot;, QtdeMesesInicio = 13, QtdeMesesFim = 24, PercentualDesconto = (decimal)17.5 });
                databaseContext.descontoImpostoRendas!.Add(new DescontoImpostoRenda { IdDescontoImpostoRenda = Guid.NewGuid(), Descricao = &quot;&#39;Acima de 24 meses&#39;&quot;, QtdeMesesInicio = 25, QtdeMesesFim = null, PercentualDesconto = (decimal)15 });



                await databaseContext.SaveChangesAsync();
            }


            // Adiciona dados iniciais para testar
            if (!await databaseContext.Titulos!.AnyAsync())
            {


                databaseContext.Titulos!.Add(new Titulo { IdTitulo = new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), NomeTitulo = &quot;CDB Teste&quot;, IdTipoTitulo = 3, PosFixado = true, IdIndexador = 2, TaxaRendimento = 108 });

                await databaseContext.SaveChangesAsync();
            }
            return databaseContext;
        }


        [Fact]
        public async Task ShouldReturnValorBruto()
        {
            //AAA
            //Arrange
            AppDbContext appDbContext = await getDatabaseDbContext();
            TituloRepository tituloRepository = new TituloRepository(appDbContext);
            DescontoImpostoRendaRepository descontoImpostoRendaRepository = new DescontoImpostoRendaRepository(appDbContext);
            DescontoImpostoRendaService descontoImpostoRendaService = new DescontoImpostoRendaService(descontoImpostoRendaRepository);
            TituloService tituloService = new TituloService(tituloRepository, descontoImpostoRendaService);

            //Act + Assert  - Mes 1
            var simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 1);
            Assert.Equal(Math.Round((decimal)1009.72, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 2
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 2);
            Assert.Equal(Math.Round((decimal)1019.53, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 3
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 3);
            Assert.Equal(Math.Round((decimal)1029.44, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 4
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 4);
            Assert.Equal(Math.Round((decimal)1039.45, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 5
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 5);
            Assert.Equal(Math.Round((decimal)1049.55, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 6
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 6);
            Assert.Equal(Math.Round((decimal)1059.75, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 7
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 7);
            Assert.Equal(Math.Round((decimal)1070.05, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 8
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 8);
            Assert.Equal(Math.Round((decimal)1080.45, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 9
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 9);
            Assert.Equal(Math.Round((decimal)1090.95, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 10
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 10);
            Assert.Equal(Math.Round((decimal)1101.56, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 11
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 11);
            Assert.Equal(Math.Round((decimal)1112.27, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 12
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 12);
            Assert.Equal(Math.Round((decimal)1123.08, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 13
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 13);
            Assert.Equal(Math.Round((decimal)1133.99, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 14
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 14);
            Assert.Equal(Math.Round((decimal)1145.02, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 15
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 15);
            Assert.Equal(Math.Round((decimal)1156.15, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 16
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 16);
            Assert.Equal(Math.Round((decimal)1167.38, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 17
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 17);
            Assert.Equal(Math.Round((decimal)1178.73, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 18
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 18);
            Assert.Equal(Math.Round((decimal)1190.19, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 19
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 19);
            Assert.Equal(Math.Round((decimal)1201.76, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 20
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 20);
            Assert.Equal(Math.Round((decimal)1213.44, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 21
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 21);
            Assert.Equal(Math.Round((decimal)1225.23, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 22
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 22);
            Assert.Equal(Math.Round((decimal)1237.14, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 23
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 23);
            Assert.Equal(Math.Round((decimal)1249.17, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 24
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 24);
            Assert.Equal(Math.Round((decimal)1261.31, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 25
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 25);
            Assert.Equal(Math.Round((decimal)1273.57, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 26
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 26);
            Assert.Equal(Math.Round((decimal)1285.95, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 27
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 27);
            Assert.Equal(Math.Round((decimal)1298.45, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 28
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 28);
            Assert.Equal(Math.Round((decimal)1311.07, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 29
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 29);
            Assert.Equal(Math.Round((decimal)1323.81, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 30
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 30);
            Assert.Equal(Math.Round((decimal)1336.68, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalBruto, 2, MidpointRounding.ToZero), 2);

        }

        [Fact]
        public async Task ShouldReturnValorLiquido()
        {
            //AAA
            //Arrange
            AppDbContext appDbContext = await getDatabaseDbContext();
            TituloRepository tituloRepository = new TituloRepository(appDbContext);
            DescontoImpostoRendaRepository descontoImpostoRendaRepository = new DescontoImpostoRendaRepository(appDbContext);
            DescontoImpostoRendaService descontoImpostoRendaService = new DescontoImpostoRendaService(descontoImpostoRendaRepository);
            TituloService tituloService = new TituloService(tituloRepository, descontoImpostoRendaService);

            //Act + Assert  - Mes 1
            var simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 1);   
            Assert.Equal(Math.Round((decimal)1007.53, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 2
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 2);            
            Assert.Equal(Math.Round((decimal)1015.13, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 3
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 3);
            Assert.Equal(Math.Round((decimal)1022.81, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 4
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 4);
            Assert.Equal(Math.Round((decimal)1030.57, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 5
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 5);
            Assert.Equal(Math.Round((decimal)1038.40, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 6
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 6);
            Assert.Equal(Math.Round((decimal)1046.31, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 7
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 7);
            Assert.Equal(Math.Round((decimal)1056.04, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 8
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 8);
            Assert.Equal(Math.Round((decimal)1064.36, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 9
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 9);
            Assert.Equal(Math.Round((decimal)1072.76, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 10
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 10);
            Assert.Equal(Math.Round((decimal)1081.25, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 11
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 11);
            Assert.Equal(Math.Round((decimal)1089.81, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 12
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 12);
            Assert.Equal(Math.Round((decimal)1098.46, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 13
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 13);
            Assert.Equal(Math.Round((decimal)1110.54, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 14
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 14);
            Assert.Equal(Math.Round((decimal)1119.64, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 15
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 15);
            Assert.Equal(Math.Round((decimal)1128.82, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 16
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 16);
            Assert.Equal(Math.Round((decimal)1138.09, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 17
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 17);
            Assert.Equal(Math.Round((decimal)1147.45, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 18
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 18);
            Assert.Equal(Math.Round((decimal)1156.90, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 19
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 19);
            Assert.Equal(Math.Round((decimal)1166.45, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 20
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 20);
            Assert.Equal(Math.Round((decimal)1176.08, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 21
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 21);
            Assert.Equal(Math.Round((decimal)1185.82, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 22
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 22);
            Assert.Equal(Math.Round((decimal)1195.64, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 23
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 23);
            Assert.Equal(Math.Round((decimal)1205.56, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 24
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 24);
            Assert.Equal(Math.Round((decimal)1215.58, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 25
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 25);
            Assert.Equal(Math.Round((decimal)1232.53, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 26
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 26);
            Assert.Equal(Math.Round((decimal)1243.05, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 27
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 27);
            Assert.Equal(Math.Round((decimal)1253.68, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 28
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 28);
            Assert.Equal(Math.Round((decimal)1264.41, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 29
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 29);
            Assert.Equal(Math.Round((decimal)1275.24, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);

            //Act + Assert  - Mes 30
            simulacao = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 30);
            Assert.Equal(Math.Round((decimal)1286.18, 2, MidpointRounding.ToZero), Math.Round(simulacao.ValorTotalLiquido, 2, MidpointRounding.ToZero), 2);
        }



        [Fact]
        public async Task ShouldReturnErrorWhenValorInicialEqualsZero()
        {
            //AAA
            //Arrange
            AppDbContext appDbContext = await getDatabaseDbContext();
            TituloRepository tituloRepository = new TituloRepository(appDbContext);
            DescontoImpostoRendaRepository descontoImpostoRendaRepository = new DescontoImpostoRendaRepository(appDbContext);
            DescontoImpostoRendaService descontoImpostoRendaService = new DescontoImpostoRendaService(descontoImpostoRendaRepository);
            TituloService tituloService = new TituloService(tituloRepository, descontoImpostoRendaService);


            //Act
            Exception exception = await Record.ExceptionAsync(() =&gt; tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 0, 2));

            //Assert
            Assert.Equal(&quot;Valor Inicial deve ser maior que zero&quot;, exception.Message);

        }

        [Fact]
        public async Task ShouldReturnErrorWhenQtdeMesesEqualsZero()
        {
            //AAA
            //Arrange
            AppDbContext appDbContext = await getDatabaseDbContext();
            TituloRepository tituloRepository = new TituloRepository(appDbContext);
            DescontoImpostoRendaRepository descontoImpostoRendaRepository = new DescontoImpostoRendaRepository(appDbContext);
            DescontoImpostoRendaService descontoImpostoRendaService = new DescontoImpostoRendaService(descontoImpostoRendaRepository);
            TituloService tituloService = new TituloService(tituloRepository, descontoImpostoRendaService);           

            //Act
            Exception exception = await Record.ExceptionAsync(() =&gt; tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, 0));

            //Assert
            Assert.Equal(&quot;Quantidade de meses investidos deve ser no minimo igual a um.&quot;, exception.Message);

        }

        [Fact]
        public async Task ShouldReturnImpostoRendaPercentualBasedOnQtdeMeses()
        {
            //AAA
            //Arrange
            AppDbContext appDbContext = await getDatabaseDbContext();
            TituloRepository tituloRepository = new TituloRepository(appDbContext);
            DescontoImpostoRendaRepository descontoImpostoRendaRepository = new DescontoImpostoRendaRepository(appDbContext);
            DescontoImpostoRendaService descontoImpostoRendaService = new DescontoImpostoRendaService(descontoImpostoRendaRepository);
            TituloService tituloService = new TituloService(tituloRepository, descontoImpostoRendaService);



            int qtdMes = 1;
            decimal percentual;

            while (qtdMes &lt;= 30)
            {
                if (qtdMes &lt;= 6)
                {
                    percentual = (decimal)22.5;
                }
                else if (qtdMes &lt;= 12)
                {
                    percentual = (decimal)20;

                }
                else if (qtdMes &lt;= 24)
                {
                    percentual = (decimal)17.5;

                }
                else
                {
                    percentual = (decimal)15;
                }

                //Act
                var simulacaoMes = await tituloService.GetSimularTitulo(new Guid(&quot;C2CCD2C3-2A9E-45A9-B407-3FDFE5D95FED&quot;), 1000, qtdMes);

                //Assert
                Assert.Equal(percentual, (simulacaoMes.ValorDescontoImpostoRenda * 100 / simulacaoMes.ValorRendimento), 2);

                qtdMes++;
            }


        }


    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,9,12,10,1],[13,13,15,22,1],[17,13,17,61,1],[18,13,18,65,1],[23,13,23,64,1],[24,13,24,14,1],[25,17,25,170,1],[26,17,26,168,1],[27,17,27,169,1],[29,17,29,58,1],[30,13,30,14,1],[33,13,33,64,1],[34,13,34,14,1],[35,17,35,135,1],[36,17,36,133,1],[37,17,37,124,1],[39,17,39,58,1],[40,13,40,14,1],[44,13,44,74,1],[45,13,45,14,1],[46,17,46,235,1],[47,17,47,234,1],[48,17,48,237,1],[49,17,49,242,1],[53,17,53,58,1],[54,13,54,14,1],[58,13,58,60,1],[59,13,59,14,1],[62,17,62,223,1],[64,17,64,58,1],[65,13,65,14,1],[66,13,66,36,1],[67,9,67,10,1],[72,9,72,10,1],[75,13,75,70,1],[76,13,76,84,1],[77,13,77,126,1],[78,13,78,135,1],[79,13,79,108,1],[82,13,82,125,1],[83,13,83,154,1],[86,13,86,121,1],[87,13,87,154,1],[90,13,90,121,1],[91,13,91,154,1],[94,13,94,121,1],[95,13,95,154,1],[98,13,98,121,1],[99,13,99,154,1],[102,13,102,121,1],[103,13,103,154,1],[106,13,106,121,1],[107,13,107,154,1],[110,13,110,121,1],[111,13,111,154,1],[114,13,114,121,1],[115,13,115,154,1],[118,13,118,122,1],[119,13,119,154,1],[122,13,122,122,1],[123,13,123,154,1],[126,13,126,122,1],[127,13,127,154,1],[130,13,130,122,1],[131,13,131,154,1],[134,13,134,122,1],[135,13,135,154,1],[138,13,138,122,1],[139,13,139,154,1],[142,13,142,122,1],[143,13,143,154,1],[146,13,146,122,1],[147,13,147,154,1],[150,13,150,122,1],[151,13,151,154,1],[154,13,154,122,1],[155,13,155,154,1],[158,13,158,122,1],[159,13,159,154,1],[162,13,162,122,1],[163,13,163,154,1],[166,13,166,122,1],[167,13,167,154,1],[170,13,170,122,1],[171,13,171,154,1],[174,13,174,122,1],[175,13,175,154,1],[178,13,178,122,1],[179,13,179,154,1],[182,13,182,122,1],[183,13,183,154,1],[186,13,186,122,1],[187,13,187,154,1],[190,13,190,122,1],[191,13,191,154,1],[194,13,194,122,1],[195,13,195,154,1],[198,13,198,122,1],[199,13,199,154,1],[201,9,201,10,1],[205,9,205,10,1],[208,13,208,70,1],[209,13,209,84,1],[210,13,210,126,1],[211,13,211,135,1],[212,13,212,108,1],[215,13,215,125,1],[216,13,216,156,1],[219,13,219,121,1],[220,13,220,156,1],[223,13,223,121,1],[224,13,224,156,1],[227,13,227,121,1],[228,13,228,156,1],[231,13,231,121,1],[232,13,232,156,1],[235,13,235,121,1],[236,13,236,156,1],[239,13,239,121,1],[240,13,240,156,1],[243,13,243,121,1],[244,13,244,156,1],[247,13,247,121,1],[248,13,248,156,1],[251,13,251,122,1],[252,13,252,156,1],[255,13,255,122,1],[256,13,256,156,1],[259,13,259,122,1],[260,13,260,156,1],[263,13,263,122,1],[264,13,264,156,1],[267,13,267,122,1],[268,13,268,156,1],[271,13,271,122,1],[272,13,272,156,1],[275,13,275,122,1],[276,13,276,156,1],[279,13,279,122,1],[280,13,280,156,1],[283,13,283,122,1],[284,13,284,156,1],[287,13,287,122,1],[288,13,288,156,1],[291,13,291,122,1],[292,13,292,156,1],[295,13,295,122,1],[296,13,296,156,1],[299,13,299,122,1],[300,13,300,156,1],[303,13,303,122,1],[304,13,304,156,1],[307,13,307,122,1],[308,13,308,156,1],[311,13,311,122,1],[312,13,312,156,1],[315,13,315,122,1],[316,13,316,156,1],[319,13,319,122,1],[320,13,320,156,1],[323,13,323,122,1],[324,13,324,156,1],[327,13,327,122,1],[328,13,328,156,1],[331,13,331,122,1],[332,13,332,156,1],[333,9,333,10,1],[339,9,339,10,1],[342,13,342,70,1],[343,13,343,84,1],[344,13,344,126,1],[345,13,345,135,1],[346,13,346,108,1],[350,13,350,69,1],[350,69,350,155,1],[350,155,350,157,1],[353,13,353,86,1],[355,9,355,10,1],[359,9,359,10,1],[362,13,362,70,1],[363,13,363,84,1],[364,13,364,126,1],[365,13,365,135,1],[366,13,366,108,1],[369,13,369,69,1],[369,69,369,158,1],[369,158,369,160,1],[372,13,372,110,1],[374,9,374,10,1],[378,9,378,10,1],[381,13,381,70,1],[382,13,382,84,1],[383,13,383,126,1],[384,13,384,135,1],[385,13,385,108,1],[389,13,389,28,1],[392,13,392,33,1],[393,13,393,14,1],[394,17,394,33,1],[395,17,395,18,1],[396,21,396,48,1],[397,17,397,18,1],[398,22,398,39,1],[399,17,399,18,1],[400,21,400,46,1],[402,17,402,18,1],[403,22,403,39,1],[404,17,404,18,1],[405,21,405,48,1],[407,17,407,18,1],[409,17,409,18,1],[410,21,410,46,1],[411,17,411,18,1],[414,17,414,137,1],[417,17,417,124,1],[419,17,419,26,1],[420,13,420,14,1],[423,9,423,10,1]]);
    </script>
  </body>
</html>